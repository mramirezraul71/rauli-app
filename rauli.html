<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RAULI ‚Äî Panader√≠a & Dulcer√≠a</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#123b8a">
  <link rel="icon" href="icon-512.png">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1c33;
      --card2:#0d1730;
      --text:#eef3ff;
      --muted:#b7c4e6;

      --blue:#2f6cff;
      --blue2:#1f4fc9;

      --yellow:#f1c40f;
      --yellow2:#d7a90b;

      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 55px rgba(0,0,0,.42);
      --radius: 22px;

      /* Tipograf√≠a (Lisi) */
      --fs-base: 17px;
      --fs-small: 14px;
      --fs-title: 20px;
      --fs-h1: 22px;
      --fs-card-title: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: var(--fs-base);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(47,108,255,.38), transparent 55%),
        radial-gradient(1100px 700px at 95% 0%, rgba(241,196,15,.25), transparent 50%),
        radial-gradient(900px 600px at 60% 110%, rgba(47,108,255,.20), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Animaciones (m√°s viva) */
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
    @keyframes pulse{0%{transform:scale(1); opacity:.8}50%{transform:scale(1.12);opacity:1}100%{transform:scale(1);opacity:.85}}
    @keyframes shimmer{0%{background-position:0% 50%}100%{background-position:100% 50%}}

    /* Top bar */
    .topbar{
      position: sticky; top:0; z-index:50;
      padding: 12px 12px 10px;
      background: linear-gradient(180deg, rgba(11,18,32,.96), rgba(11,18,32,.60));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1120px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(47,108,255,.95), rgba(241,196,15,.90));
      box-shadow: 0 12px 24px rgba(0,0,0,.30);
      animation: floaty 3.2s ease-in-out infinite;
    }
    .title{display:flex; flex-direction:column; line-height:1.12}
    .title b{letter-spacing:.4px; font-size:18px}
    .title span{color:var(--muted); font-size:var(--fs-small)}
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:9px 11px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.07);
      color: var(--text);
      font-size: var(--fs-small);
      font-weight: 900;
    }

    .dot{width:10px;height:10px;border-radius:50%}
    .dot.online{background:#2ecc71}
    .dot.offline{background:#e74c3c}

    .pulse{
      width:10px;height:10px;border-radius:50%;
      background:#2ecc71;
      box-shadow: 0 0 0 0 rgba(46,204,113,.65);
      animation: pulse 1.4s ease-in-out infinite;
    }

    /* Botones */
    .btn{
      border:0; cursor:pointer;
      font-weight: 950;
      letter-spacing:.2px;
      padding:11px 13px;
      border-radius:16px;
      color:#0b1220; /* amarillo con texto oscuro = alta legibilidad */
      background: linear-gradient(135deg, var(--yellow), var(--yellow2));
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      display:inline-flex; gap:8px; align-items:center;
      font-size: var(--fs-small);
    }
    .btn.blue{
      color:#ffe08a; /* texto amarillo en azul (tu pedido) */
      background: linear-gradient(135deg, var(--blue), var(--blue2));
    }
    .btn.ghost{
      color:#fff;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.danger{
      color:#fff;
      background: linear-gradient(135deg, #e74c3c, #b3392f);
    }

    /* Main */
    .wrap{max-width:1120px;margin:0 auto;padding:16px 12px 120px}
    .hero{
      display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap;
      padding:16px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(47,108,255,.25), rgba(241,196,15,.18), rgba(47,108,255,.25));
      background-size: 200% 200%;
      animation: shimmer 7s ease-in-out infinite;
      opacity:.5;
      pointer-events:none;
      mask: linear-gradient(#000, transparent 70%);
    }
    .hero h1{margin:0;font-size:var(--fs-h1); position:relative}
    .hero p{margin:8px 0 0;color:var(--muted);font-size:var(--fs-base);max-width:740px; position:relative}
    .hero-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap; position:relative}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      padding:16px 16px 14px;
      border-radius: 20px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,28,51,.90), rgba(13,23,48,.86));
      box-shadow: 0 14px 38px rgba(0,0,0,.26);
      min-height: 140px;
      display:flex; flex-direction:column; gap:10px;
      transform: translateY(0);
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow: 0 18px 48px rgba(0,0,0,.34);
      border-color: rgba(241,196,15,.35);
    }
    .card b{font-size:var(--fs-card-title)}
    .card small{color:var(--muted);line-height:1.45; font-size: var(--fs-base)}
    .card .tag{
      margin-top:auto;
      display:inline-flex; align-self:flex-start;
      padding:8px 11px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      font-weight: 950;
      font-size: var(--fs-small);
    }

    /* Bottom nav */
    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      z-index:60;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(11,18,32,.00), rgba(11,18,32,.94));
      backdrop-filter: blur(10px);
    }
    .bottom-inner{
      max-width:1120px;margin:0 auto;
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(8,12,20,.62);
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      box-shadow: var(--shadow);
      flex-wrap:wrap;
    }
    .nav{display:flex; gap:8px; flex-wrap:wrap}
    .nav button{
      padding:11px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color:#fff;
      font-weight: 950;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
      font-size: var(--fs-small);
    }
    .nav button.active{
      color:#ffe08a;
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      border:0;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:9999;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
    }
    .modal.show{display:flex}

    .sheet{
      width:min(920px,100%);
      border-radius: 24px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,35,85,.96), rgba(10,14,22,.96));
      box-shadow: 0 22px 80px rgba(0,0,0,.48);
      overflow:hidden;
    }
    .sheet-top{
      padding:14px 16px;
      display:flex; gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }
    .sheet-top .who{display:flex; flex-direction:column; gap:3px}
    .sheet-top .who b{letter-spacing:.2px; font-size: 17px}
    .sheet-top .who span{color:var(--muted);font-size:var(--fs-small)}
    .sheet-body{padding:14px 16px}
    .module-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .module-grid{grid-template-columns:1fr;} }

    .module{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      text-align:left;
      transition: transform .14s ease, border-color .14s ease;
    }
    .module:hover{
      transform: translateY(-2px);
      border-color: rgba(241,196,15,.40);
    }
    .module b{display:block; font-size: 16px}
    .module small{display:block;color:var(--muted);margin-top:6px;line-height:1.45; font-size: var(--fs-base)}
    .quick{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}

    /* Login */
    .login-wrap{
      max-width: 680px;
      margin: 18px auto 0;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,28,51,.85), rgba(13,23,48,.75));
      box-shadow: var(--shadow);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{
      display:flex; flex-direction:column; gap:8px;
      flex: 1 1 240px;
    }
    label{color:var(--muted); font-weight:900; font-size: var(--fs-small)}
    input{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:#fff;
      outline:none;
      font-size: var(--fs-base);
    }
    input:focus{border-color: rgba(241,196,15,.45)}
    .hint{color:var(--muted); font-size: var(--fs-small); margin-top:10px; line-height:1.45}

    /* Asistente */
    .assistant{
      margin-top: 14px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .assistant h2{margin:0; font-size: var(--fs-title)}
    .assistant p{margin:8px 0 0; color:var(--muted)}
    .assistant .box{
      margin-top:10px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    textarea{
      width:100%;
      min-height: 88px;
      resize: vertical;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:#fff;
      font-size: var(--fs-base);
      outline:none;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 92px;
      z-index:99999;
      padding:12px 14px;
      border-radius: 14px;
      color:#fff;
      font: 14px system-ui;
      box-shadow: 0 12px 34px rgba(0,0,0,.28);
      background: rgba(24,90,255,.92);
      display:none;
      max-width: min(560px, 92vw);
    }
    .toast.show{display:block}
    .toast.bad{background: rgba(231,76,60,.92)}

    /* Footer / autor */
    .footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: var(--fs-small);
      text-align:center;
      opacity:.9;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>RAULI</b>
          <span id="subTitle">Panader√≠a & Dulcer√≠a ¬∑ Offline-first + Nube</span>
        </div>
      </div>

      <div class="chips">
        <button class="btn" id="btnUpdate">üîî Actualizar</button>
        <span class="chip" id="chipConn"><span class="dot offline"></span> Offline</span>
        <span class="chip" id="chipSync">üü• Sin se√±al (guardando local)</span>
        <span class="chip" id="chipUser" style="display:none">üë§ ‚Äî</span>
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="hero">
      <div>
        <h1>Panel operativo por roles (Paso 2)</h1>
        <p>
          Ahora la entrada es con <b>Login</b> (Firebase Auth) y la app te coloca autom√°ticamente en tu rol.
          El <b>Asistente</b> guarda mensajes offline y los env√≠a cuando vuelve la se√±al.
        </p>
      </div>
      <div class="hero-actions">
        <button class="btn blue" id="btnProbe">üöÄ Probar Nube</button>
        <button class="btn ghost" id="btnAbout">‚ÑπÔ∏è Acerca de</button>
        <button class="btn danger" id="btnLogout" style="display:none">Salir</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="login-wrap" id="loginBox">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
        <div>
          <b style="font-size:18px">üîê Iniciar sesi√≥n</b>
          <div class="hint">Usa el correo/clave del usuario creado en Firebase Authentication.</div>
        </div>
        <button class="btn ghost" id="btnInstall">üì≤ Instalar App</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="field">
          <label>Correo</label>
          <input id="email" type="email" placeholder="ej: bety@rauli.com" autocomplete="username">
        </div>
        <div class="field">
          <label>Clave</label>
          <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn blue" id="btnLogin">Entrar</button>
        <button class="btn ghost" id="btnQuickRole">Entrar demo (sin login)</button>
      </div>

      <div class="hint">
        <b>Nota:</b> Si haces ‚ÄúEntrar demo‚Äù es solo para ver pantallas. Para reglas seguras usamos Login real.
      </div>
    </div>

    <!-- DASHBOARD (se muestra al loguear) -->
    <div id="dashBox" style="display:none">
      <div class="grid" id="roleCards"></div>

      <!-- Asistente -->
      <div class="assistant">
        <h2>ü§ñ Asistente RAULI (offline/online)</h2>
        <p>
          Escribe o dicta. Si no hay se√±al, queda en cola. Cuando vuelve la conexi√≥n, se env√≠a a la nube y queda registrado.
          (Luego lo conectamos a IA real v√≠a Firebase Functions).
        </p>

        <div class="box">
          <textarea id="assistantInput" placeholder="Ej: 'Bety: hoy faltaron $10 en caja, revisar evidencias'"></textarea>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn blue" id="btnSendMsg">Enviar / Guardar</button>
            <button class="btn ghost" id="btnVoice">üéôÔ∏è Dictar</button>
            <button class="btn ghost" id="btnFlush">üì° Enviar cola</button>
          </div>

          <div class="hint" id="queueHint">Cola offline: 0</div>
        </div>
      </div>

      <div class="footer">
        Autor del prototipo: <b>ChatGPT (GPT-5.2 Thinking)</b> ¬∑ RAULI v2 (Login + Asistente Offline/Online)
      </div>
    </div>

  </div>

  <!-- Bottom -->
  <div class="bottom">
    <div class="bottom-inner">
      <div class="nav">
        <button class="active" id="navHome">üè† Inicio</button>
        <button id="navCaja">üí∞ Caja</button>
        <button id="navInv">üì¶ Inventario</button>
        <button id="navProd">ü•ñ Producci√≥n</button>
        <button id="navVentas">üßæ Ventas</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn ghost" id="btnBot">ü§ñ Asistente</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-top">
        <div class="who">
          <b id="whoName">Usuario</b>
          <span id="whoMeta">Rol ¬∑ M√≥dulos disponibles</span>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="btnInitBase" style="display:none">üì¶ Inicializar base</button>
          <button class="btn ghost" id="btnClose">Cerrar</button>
        </div>
      </div>
      <div class="sheet-body">
        <div class="module-grid" id="moduleGrid"></div>

        <div class="quick">
          <button class="btn blue" id="btnOpenCash">üí∞ Apertura de caja (hoy)</button>
          <button class="btn ghost" id="btnQuickInsumo">üì¶ Registrar insumo (r√°pido)</button>
          <button class="btn ghost" id="btnBack">‚Ü©Ô∏è Volver</button>
        </div>
      </div>
    </div>
  </div>

  <!-- About modal (simple) -->
  <div class="modal" id="aboutModal">
    <div class="sheet">
      <div class="sheet-top">
        <div class="who">
          <b>‚ÑπÔ∏è Acerca de RAULI</b>
          <span>Prototipo operativo con Offline-first + Firebase + Asistente</span>
        </div>
        <button class="btn ghost" id="btnAboutClose">Cerrar</button>
      </div>
      <div class="sheet-body">
        <div class="module" style="cursor:default">
          <b>Autor</b>
          <small>ChatGPT (GPT-5.2 Thinking) ‚Äî Autor del prototipo RAULI.</small>
        </div>
        <div class="module" style="cursor:default;margin-top:10px">
          <b>IA (siguiente nivel)</b>
          <small>
            Recomendado: conectar el asistente a una <b>Cloud Function</b> (servidor seguro) que llame a IA y devuelva respuesta.
            Offline: se encola y al volver internet se sincroniza autom√°ticamente.
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Helpers UI
    const toastEl = document.getElementById('toast');
    function toast(msg, ok=true){
      toastEl.textContent = msg;
      toastEl.classList.toggle('bad', !ok);
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Campanita sin archivos (WebAudio)
    function ding(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
        o.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.08);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
        setTimeout(()=>{ o.stop(); ctx.close(); }, 320);
      }catch(e){}
    }

    // Online / Offline chips
    const chipConn = document.getElementById('chipConn');
    const chipSync = document.getElementById('chipSync');
    function paintConn(){
      const online = navigator.onLine;
      chipConn.innerHTML = online
        ? `<span class="dot online"></span> Online`
        : `<span class="dot offline"></span> Offline`;
      chipSync.textContent = online ? "‚úÖ En l√≠nea (guardando local tambi√©n)" : "üü• Sin se√±al (guardando local)";
    }
    window.addEventListener('online', paintConn);
    window.addEventListener('offline', paintConn);
    paintConn();

    // PWA install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
    });

    document.getElementById('btnInstall').addEventListener('click', async ()=>{
      if(!deferredPrompt){
        toast("iPhone: Safari ‚Üí Compartir ‚Üí 'Agregar a inicio'. Android/PC: Chrome te mostrar√° banner.", true);
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      toast(choice?.outcome === 'accepted' ? "‚úÖ Instalaci√≥n iniciada" : "Instalaci√≥n cancelada", true);
    });

    // Service worker register (si existe sw.js)
    (async ()=>{
      if('serviceWorker' in navigator){
        try{ await navigator.serviceWorker.register('./sw.js', { scope:'./' }); }catch(e){}
      }
    })();

    // Update
    document.getElementById('btnUpdate').addEventListener('click', ()=>{
      ding();
      toast("Actualizando versi√≥n‚Ä¶", true);
      setTimeout(()=>location.reload(true), 350);
    });

    // About
    const aboutModal = document.getElementById('aboutModal');
    document.getElementById('btnAbout').addEventListener('click', ()=>aboutModal.classList.add('show'));
    document.getElementById('btnAboutClose').addEventListener('click', ()=>aboutModal.classList.remove('show'));

    // Bottom nav quick
    const navBtns = ["navHome","navCaja","navInv","navProd","navVentas"].map(id=>document.getElementById(id));
    navBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        navBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        toast("M√≥dulo: " + b.textContent.replace(/\s+/g,' ').trim(), true);
      });
    });

    // Bot button scroll
    document.getElementById('btnBot').addEventListener('click', ()=>{
      document.getElementById('assistantInput')?.scrollIntoView({behavior:'smooth', block:'center'});
      toast("ü§ñ Asistente listo (escribe o dicta)", true);
    });
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, enableIndexedDbPersistence,
      doc, getDoc, setDoc,
      collection, addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ===== Firebase config (tu proyecto) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCGPDlRAIKsrI6EhE3Tb2-1sYJ1VDaH2jw",
      authDomain: "rauli-e7fdb.firebaseapp.com",
      projectId: "rauli-e7fdb",
      storageBucket: "rauli-e7fdb.firebasestorage.app",
      messagingSenderId: "406292569158",
      appId: "1:406292569158:web:c26f46de60d31827317e47",
      measurementId: "G-PVC6X0TTTL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Offline-first Firestore
    try { await enableIndexedDbPersistence(db); } catch(e) {}

    const $ = (id)=>document.getElementById(id);
    function toast(msg, ok=true){
      const t = $('toast');
      t.textContent = msg;
      t.classList.toggle('bad', !ok);
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2600);
    }

    const RAULI_BIZ = "rauli";
    const bizDocRef = () => doc(db, "business", RAULI_BIZ);

    // Perfiles (roles) en: business/rauli/users/{uid}
    const userProfileRef = (uid)=>doc(db, "business", RAULI_BIZ, "users", uid);

    // Colecciones operativas
    const subCol = (name) => collection(db, "business", RAULI_BIZ, name);

    function nowISO(){
      const d=new Date();
      return d.toISOString().slice(0,10);
    }

    // ========= ROLES =========
    const ROLES = {
      owner:   { name:"Ra√∫l (Due√±o)", modules:["Caja","Inventario","Producci√≥n","Ventas","Contabilidad","Auditor√≠a","Configuraci√≥n"] },
      coowner: { name:"Lisi (Co-propietaria)", modules:["Caja","Inventario","Producci√≥n","Ventas","Contabilidad","Auditor√≠a"] },
      supervisor:{ name:"Orlandito (Supervisor)", modules:["Calidad","Inventario","Producci√≥n","Ventas","Auditor√≠a"] },
      admin_ops:{ name:"Papito (Producci√≥n)", modules:["Producci√≥n","Inventario","Ventas","Caja"] },
      accountant:{ name:"Bety (Contadora)", modules:["Caja","Gastos","Cierres","Evidencias","Auditor√≠a"] },
    };

    // ========= Estado de sesi√≥n =========
    let current = {
      uid:null,
      displayName:null,
      role:null,
      email:null
    };

    function showLogin(){
      $('loginBox').style.display = "block";
      $('dashBox').style.display = "none";
      $('btnLogout').style.display = "none";
      $('chipUser').style.display = "none";
    }

    function showDash(){
      $('loginBox').style.display = "none";
      $('dashBox').style.display = "block";
      $('btnLogout').style.display = "inline-flex";
      $('chipUser').style.display = "inline-flex";
      $('chipUser').textContent = `üë§ ${current.displayName || current.email || 'Usuario'} ¬∑ ${current.role || 'rol'}`;
    }

    // ========= UI: modal por rol =========
    function openRole(roleKey){
      const modal = $('modal');
      const r = ROLES[roleKey] || ROLES.owner;

      $('whoName').textContent = current.displayName ? `${current.displayName}` : r.name;
      $('whoMeta').textContent = `Rol: ${roleKey} ¬∑ M√≥dulos: ${r.modules.length}`;

      const grid = $('moduleGrid');
      grid.innerHTML = "";
      r.modules.forEach(m=>{
        const b = document.createElement("button");
        b.className = "module";
        b.innerHTML = `<b>${m}</b><small>Abrir m√≥dulo ${m.toLowerCase()} y registrar evidencias.</small>`;
        b.onclick = async ()=>{
          try{
            await addDoc(subCol("auditoria"), {
              type:"open_module",
              module:m,
              role:roleKey,
              uid: current.uid || null,
              at: serverTimestamp()
            });
          }catch(e){}
          toast("Abriendo: " + m, true);
        };
        grid.appendChild(b);
      });

      // Solo due√±o ve Inicializar Base
      $('btnInitBase').style.display = (roleKey === "owner") ? "inline-flex" : "none";
      modal.classList.add("show");
    }

    function closeRole(){ $('modal').classList.remove("show"); }
    $('btnClose').addEventListener('click', closeRole);
    $('btnBack').addEventListener('click', closeRole);

    // ========= Inicializar base (solo owner) =========
    async function ensureBizMeta(){
      const ref = bizDocRef();
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          name:"Panader√≠a & Dulcer√≠a RAULI",
          createdAt: serverTimestamp(),
          version:"v2",
          status:"active"
        });
      }
    }

    async function ensureConfig(){
      const ref = doc(db, "business", RAULI_BIZ, "config", "general");
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          currency:"USD",
          timezone:"America/New_York",
          lowStockThreshold: 5,
          createdAt: serverTimestamp()
        });
      }
    }

    async function seedBaseCollections(){
      const marker = { createdAt: serverTimestamp(), seed:true };

      await addDoc(subCol("inventario"), {
        ...marker, type:"insumo", sku:"HARINA-0001", name:"Harina (demo)",
        unit:"lb", qty:50, min:10, costUnit:0
      });

      await addDoc(subCol("produccion"), {
        ...marker, type:"lote", product:"Pan (demo)", qty:20, status:"en_proceso", date: nowISO()
      });

      await addDoc(subCol("ventas"), {
        ...marker, type:"venta", date: nowISO(), total:0, method:"efectivo", note:"Venta demo"
      });

      await addDoc(subCol("caja"), {
        ...marker, type:"apertura", date: nowISO(), amount:0, note:"Caja demo"
      });

      await addDoc(subCol("auditoria"), {
        ...marker, type:"seed", msg:"Base inicial creada desde RAULI", at: serverTimestamp()
      });
    }

    async function initBase(){
      try{
        await ensureBizMeta();
        await ensureConfig();
        await seedBaseCollections();
        toast("‚úÖ Base RAULI inicializada", true);
      }catch(e){
        toast("‚ùå Error inicializando base: " + (e?.message || e), false);
      }
    }
    $('btnInitBase').addEventListener('click', initBase);

    // ========= Acciones r√°pidas =========
    async function openCashToday(){
      try{
        await addDoc(subCol("caja"), {
          type:"apertura",
          date: nowISO(),
          amount: 0,
          byRole: current.role,
          uid: current.uid,
          at: serverTimestamp(),
          note: "Apertura creada desde RAULI"
        });
        toast("‚úÖ Apertura de caja registrada", true);
      }catch(e){
        toast("‚ùå Error caja: " + (e?.message || e), false);
      }
    }
    $('btnOpenCash').addEventListener('click', openCashToday);

    async function quickInsumo(){
      try{
        await addDoc(subCol("inventario"), {
          type:"insumo",
          sku:"INS-" + Math.floor(Math.random()*99999),
          name:"Insumo r√°pido",
          unit:"unidad",
          qty: 1,
          min: 1,
          byRole: current.role,
          uid: current.uid,
          at: serverTimestamp()
        });
        toast("‚úÖ Insumo registrado (demo)", true);
      }catch(e){
        toast("‚ùå Error inventario: " + (e?.message || e), false);
      }
    }
    $('btnQuickInsumo').addEventListener('click', quickInsumo);

    // ========= PROBAR NUBE =========
    async function probeCloud(){
      try{
        await addDoc(collection(db, "business", RAULI_BIZ, "events"), {
          type:"test",
          desc:"Prueba Firestore OK (RAULI v2)",
          uid: current.uid || null,
          role: current.role || null,
          clientTime: Date.now(),
          createdAt: serverTimestamp()
        });
        toast("‚úÖ ¬°Listo! Firestore escribi√≥. Ve a Firebase > Datos.", true);
      }catch(e){
        toast("‚ùå Error Firestore: " + (e?.message || e), false);
      }
    }
    $('btnProbe').addEventListener('click', probeCloud);

    // ========= Dashboard cards din√°micas =========
    function renderRoleCards(roleKey){
      const holder = $('roleCards');
      holder.innerHTML = "";
      const r = ROLES[roleKey] || ROLES.owner;

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <b>${r.name}</b>
        <small>Tu panel est√° listo. Entra a tus m√≥dulos y registra evidencias.</small>
        <span class="tag">Entrar</span>
      `;
      card.addEventListener('click', ()=>openRole(roleKey));
      holder.appendChild(card);
    }

    // ========= ASISTENTE: cola offline + voz + sync =========
    const QUEUE_KEY = "rauli_assistant_queue_v1";

    function getQueue(){
      try{ return JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]"); }
      catch(e){ return []; }
    }
    function setQueue(arr){
      localStorage.setItem(QUEUE_KEY, JSON.stringify(arr));
      $('queueHint').textContent = `Cola offline: ${arr.length}`;
    }
    setQueue(getQueue());

    async function saveAssistantMessage(payload){
      // Guarda SIEMPRE en Firestore (si hay internet, se sube; si no, queda en cache de Firestore + cola local)
      await addDoc(subCol("assistantMessages"), {
        ...payload,
        uid: current.uid || null,
        role: current.role || null,
        createdAt: serverTimestamp()
      });
    }

    // Aqu√≠ conectaremos IA real luego:
    // Recomendado: Cloud Function (segura) que llama a IA.
    async function callAIOnline(text){
      // Placeholder: por ahora devuelve respuesta "operativa"
      // Luego lo cambiamos a fetch("https://TU-FUNCTION-URL/ai", {method:"POST", body:...})
      return `‚úÖ Recibido. Qued√≥ registrado. (Siguiente paso: IA analizar√° esto y generar√° reporte/acci√≥n.)`;
    }

    async function enqueueOrSend(text, source="texto"){
      const item = {
        id: "m_" + Math.random().toString(16).slice(2),
        text,
        source,
        ts: Date.now(),
        status: navigator.onLine ? "sending" : "queued"
      };

      if(!navigator.onLine){
        const q = getQueue();
        q.push(item);
        setQueue(q);
        toast("üü• Sin se√±al: guardado en cola offline", true);
        return;
      }

      // Online: guarda + pide respuesta AI (placeholder) + guarda respuesta
      try{
        await saveAssistantMessage({ type:"user", text, source, clientTime: item.ts });
        const ai = await callAIOnline(text);
        await saveAssistantMessage({ type:"ai", text: ai, source:"ai", clientTime: Date.now() });
        toast("‚úÖ Enviado y registrado (con respuesta)", true);
      }catch(e){
        // Si falla, a cola
        const q = getQueue();
        item.status = "queued";
        q.push(item);
        setQueue(q);
        toast("‚ö†Ô∏è Fall√≥ env√≠o: guardado en cola", false);
      }
    }

    async function flushQueue(){
      const q = getQueue();
      if(q.length === 0){
        toast("Cola vac√≠a ‚úÖ", true);
        return;
      }
      if(!navigator.onLine){
        toast("Sin se√±al: no se puede enviar cola", false);
        return;
      }

      toast("üì° Enviando cola‚Ä¶", true);
      const rest = [];
      for(const item of q){
        try{
          await saveAssistantMessage({ type:"user", text:item.text, source:item.source, clientTime:item.ts, fromQueue:true });
          const ai = await callAIOnline(item.text);
          await saveAssistantMessage({ type:"ai", text: ai, source:"ai", clientTime: Date.now(), inResponseTo:item.id });
        }catch(e){
          rest.push(item);
        }
      }
      setQueue(rest);
      toast(rest.length ? `‚ö†Ô∏è Quedaron ${rest.length} en cola` : "‚úÖ Cola enviada completa", !rest.length);
    }

    $('btnSendMsg').addEventListener('click', async ()=>{
      const text = $('assistantInput').value.trim();
      if(!text){ toast("Escribe un mensaje primero", false); return; }
      $('assistantInput').value = "";
      await enqueueOrSend(text, "texto");
    });

    $('btnFlush').addEventListener('click', flushQueue);

    // Al volver internet: enviar cola autom√°ticamente
    window.addEventListener('online', ()=>{ flushQueue().catch(()=>{}); });

    // Voz (Web Speech API)
    let recognizing = false;
    let recog = null;

    function setupVoice(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.lang = "es-ES";
      r.interimResults = true;
      r.continuous = false;
      return r;
    }
    recog = setupVoice();

    $('btnVoice').addEventListener('click', ()=>{
      if(!recog){
        toast("Tu navegador no soporta dictado aqu√≠. (Safari iPhone s√≠ suele soportar, pero var√≠a).", false);
        return;
      }
      if(recognizing){
        recog.stop();
        return;
      }
      recognizing = true;
      toast("üéôÔ∏è Dictando‚Ä¶ habla ahora", true);

      let finalText = "";
      recog.onresult = (ev)=>{
        let interim = "";
        for (let i = ev.resultIndex; i < ev.results.length; i++){
          const tr = ev.results[i][0].transcript;
          if(ev.results[i].isFinal) finalText += tr + " ";
          else interim += tr;
        }
        $('assistantInput').value = (finalText + interim).trim();
      };
      recog.onerror = ()=>{ recognizing=false; toast("Error de voz. Intenta de nuevo.", false); };
      recog.onend = async ()=>{
        recognizing=false;
        const text = $('assistantInput').value.trim();
        if(text){
          toast("‚úÖ Dictado listo. Presiona Enviar o edita.", true);
        }else{
          toast("Dictado vac√≠o.", false);
        }
      };
      recog.start();
    });

    // ========= LOGIN =========
    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('email').value.trim();
      const pass = $('pass').value;
      if(!email || !pass){ toast("Completa correo y clave", false); return; }

      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast("‚úÖ Sesi√≥n iniciada", true);
      }catch(e){
        toast("‚ùå Login error: " + (e?.message || e), false);
      }
    });

    $('btnLogout').addEventListener('click', async ()=>{
      try{
        await signOut(auth);
        toast("Sesi√≥n cerrada", true);
      }catch(e){
        toast("Error al salir", false);
      }
    });

    // Demo sin login
    $('btnQuickRole').addEventListener('click', ()=>{
      current = { uid:null, displayName:"Demo", role:"owner", email:"demo@rauli" };
      showDash();
      renderRoleCards(current.role);
      toast("Entraste en modo demo", true);
    });

    // ========= Al iniciar / cambio de estado =========
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        current = {uid:null, displayName:null, role:null, email:null};
        showLogin();
        return;
      }

      current.uid = user.uid;
      current.email = user.email || null;

      // Cargar perfil del usuario (rol)
      // Si no existe, cae por defecto a owner (para que no te bloquee)
      try{
        const ref = userProfileRef(user.uid);
        const snap = await getDoc(ref);
        if(snap.exists()){
          const data = snap.data();
          current.role = data.role || "owner";
          current.displayName = data.name || (user.email || "Usuario");
        }else{
          current.role = "owner";
          current.displayName = user.email || "Usuario";
        }
      }catch(e){
        current.role = "owner";
        current.displayName = user.email || "Usuario";
      }

      showDash();
      renderRoleCards(current.role);

      // Registrar auditor√≠a de login
      try{
        await addDoc(subCol("auditoria"), {
          type:"login",
          uid: current.uid,
          role: current.role,
          email: current.email,
          at: serverTimestamp()
        });
      }catch(e){}

      toast(`‚úÖ Bienvenido: ${current.displayName} (${current.role})`, true);

      // al entrar, intenta enviar cola si hay internet
      if(navigator.onLine) flushQueue().catch(()=>{});
    });

  </script>
</body>
</html>
