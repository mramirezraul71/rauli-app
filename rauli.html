<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RAULI ‚Äî Panader√≠a & Dulcer√≠a</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#123b8a">
  <link rel="icon" href="icon-512.png">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1c33;
      --card2:#0d1730;
      --text:#e9eefb;
      --muted:#a9b6d6;
      --blue:#2f6cff;
      --blue2:#1f4fc9;
      --yellow:#f1c40f;
      --yellow2:#d7a90b;
      --line:rgba(255,255,255,.12);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(47,108,255,.35), transparent 55%),
                  radial-gradient(1100px 700px at 95% 0%, rgba(241,196,15,.25), transparent 50%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      padding: 12px 12px 10px;
      background: linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.55));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1080px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: linear-gradient(135deg, rgba(47,108,255,.9), rgba(241,196,15,.85));
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .title{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .title b{letter-spacing:.3px}
    .title span{color:var(--muted); font-size:12px}
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size:12px;
      font-weight:800;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.online{background:#2ecc71}
    .dot.offline{background:#e74c3c}
    .btn{
      border:0;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      padding:10px 12px;
      border-radius:14px;
      color:#0b1220;
      background: linear-gradient(135deg, var(--yellow), var(--yellow2));
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn.blue{
      color:#fff;
      background: linear-gradient(135deg, var(--blue), var(--blue2));
    }
    .btn.ghost{
      color:#fff;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;
    }

    /* Main */
    .wrap{max-width:1080px;margin:0 auto;padding:16px 12px 110px}
    .hero{
      display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
    }
    .hero h1{margin:0;font-size:18px}
    .hero p{margin:6px 0 0;color:var(--muted);font-size:13px;max-width:680px}
    .hero-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .card{
      padding:14px 14px 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,28,51,.85), rgba(13,23,48,.85));
      box-shadow: 0 14px 35px rgba(0,0,0,.25);
      min-height: 130px;
      display:flex; flex-direction:column; gap:8px;
    }
    .card b{font-size:15px}
    .card small{color:var(--muted);line-height:1.35}
    .card .tag{
      margin-top:auto;
      display:inline-flex;
      align-self:flex-start;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-weight:900;
      font-size:12px;
    }

    /* Bottom nav */
    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:60;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(11,18,32,.0), rgba(11,18,32,.92));
      backdrop-filter: blur(10px);
    }
    .bottom-inner{
      max-width:1080px;margin:0 auto;
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(8,12,20,.55);
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      box-shadow: var(--shadow);
      flex-wrap:wrap;
    }
    .nav{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .nav button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
    }
    .nav button.active{
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      border:0;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:9999;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(860px,100%);
      border-radius: 22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,35,85,.96), rgba(10,14,22,.96));
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .sheet-top{
      padding:14px 16px;
      display:flex; gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .sheet-top .who{
      display:flex; flex-direction:column; gap:2px;
    }
    .sheet-top .who b{letter-spacing:.2px}
    .sheet-top .who span{color:var(--muted);font-size:12px}
    .sheet-body{padding:14px 16px}
    .module-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .module-grid{grid-template-columns:1fr;} }
    .module{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      text-align:left;
    }
    .module b{display:block}
    .module small{display:block;color:var(--muted);margin-top:6px;line-height:1.35}
    .quick{
      margin-top:12px;
      display:flex; gap:10px; flex-wrap:wrap;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 88px;
      z-index:99999;
      padding:12px 14px;
      border-radius: 14px;
      color:#fff;
      font: 13px system-ui;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      background: rgba(24,90,255,.92);
      display:none;
      max-width: min(520px, 92vw);
    }
    .toast.show{display:block}
    .toast.bad{background: rgba(231,76,60,.92)}
  </style>
</head>

<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>RAULI</b>
          <span>Panader√≠a & Dulcer√≠a ¬∑ Offline-first + Nube</span>
        </div>
      </div>

      <div class="chips">
        <button class="btn" id="btnUpdate">üîî Actualizar</button>
        <span class="chip" id="chipConn"><span class="dot offline"></span> Offline</span>
        <span class="chip" id="chipSync">‚¨§ En l√≠nea (guardando local tambi√©n)</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <div>
        <h1>Panel de Roles</h1>
        <p>
          Cada miembro entra con su rol y registra su trabajo. La app guarda local cuando no hay se√±al y sincroniza cuando vuelve.
          Hoy activamos: Base de datos + Auditor√≠a + Caja/Inventario r√°pido.
        </p>
      </div>
      <div class="hero-actions">
        <button class="btn blue" id="btnProbe">üöÄ Probar Nube</button>
        <button class="btn ghost" id="btnDemo">Cargar demo</button>
      </div>
    </div>

    <div class="grid" id="roleCards">
      <div class="card" data-role="owner">
        <b>Ra√∫l (Due√±o)</b>
        <small>Control absoluto de todos los subsistemas y auditor√≠a completa.</small>
        <span class="tag">Entrar</span>
      </div>
      <div class="card" data-role="coowner">
        <b>Lisi (Co-propietaria)</b>
        <small>Control absoluto excepto amortizaci√≥n de inversi√≥n (se habilita luego).</small>
        <span class="tag">Entrar</span>
      </div>
      <div class="card" data-role="supervisor">
        <b>Orlandito (Supervisor)</b>
        <small>Calidad + insumos + autorizaciones operativas + extracci√≥n de efectivo (con evidencias).</small>
        <span class="tag">Entrar</span>
      </div>
      <div class="card" data-role="admin_ops">
        <b>Papito (Producci√≥n)</b>
        <small>Producci√≥n + salidas de insumos + control de operarios + ventas.</small>
        <span class="tag">Entrar</span>
      </div>
      <div class="card" data-role="accountant">
        <b>Bety (Contadora)</b>
        <small>Caja + gastos + cierres + evidencias + custodia efectivo.</small>
        <span class="tag">Entrar</span>
      </div>
    </div>
  </div>

  <!-- Bottom -->
  <div class="bottom">
    <div class="bottom-inner">
      <div class="nav">
        <button class="active" id="navHome">üè† Inicio</button>
        <button id="navCaja">üí∞ Caja</button>
        <button id="navInv">üì¶ Inventario</button>
        <button id="navProd">ü•ñ Producci√≥n</button>
        <button id="navVentas">üßæ Ventas</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn ghost" id="btnInstall">üì≤ Instalar App</button>
        <button class="btn blue" id="btnBot">ü§ñ Asistente</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-top">
        <div class="who">
          <b id="whoName">Usuario</b>
          <span id="whoMeta">Rol ¬∑ M√≥dulos disponibles</span>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="btnInitBase" style="display:none">üì¶ Inicializar base</button>
          <button class="btn ghost" id="btnClose">Cerrar</button>
        </div>
      </div>
      <div class="sheet-body">
        <div class="module-grid" id="moduleGrid"></div>

        <div class="quick">
          <button class="btn blue" id="btnOpenCash">üí∞ Apertura de caja (hoy)</button>
          <button class="btn ghost" id="btnQuickInsumo">üì¶ Registrar insumo (r√°pido)</button>
          <button class="btn ghost" id="btnBack">‚Ü©Ô∏è Volver</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // --- UI helpers (no Firebase aqu√≠) ---
    const toastEl = document.getElementById('toast');
    function toast(msg, ok=true){
      toastEl.textContent = msg;
      toastEl.classList.toggle('bad', !ok);
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Campanita sin archivos (WebAudio)
    function ding(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
        o.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.08);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
        setTimeout(()=>{ o.stop(); ctx.close(); }, 320);
      }catch(e){}
    }

    // Online / Offline chips
    const chipConn = document.getElementById('chipConn');
    const chipSync = document.getElementById('chipSync');
    function paintConn(){
      const online = navigator.onLine;
      chipConn.innerHTML = `<span class="dot ${online?'online':'offline'}"></span> ${online?'Online':'Offline'}`;
      chipSync.textContent = online ? "‚úÖ En l√≠nea (guardando local tambi√©n)" : "üü• Sin se√±al (guardando local)";
    }
    window.addEventListener('online', paintConn);
    window.addEventListener('offline', paintConn);
    paintConn();

    // PWA install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      // no spameamos, solo habilitamos bot√≥n
    });

    document.getElementById('btnInstall').addEventListener('click', async ()=>{
      if(!deferredPrompt){
        toast("En iPhone: Safari ‚Üí Compartir ‚Üí 'Agregar a inicio'. En Android/PC: espera el banner o usa Chrome.", true);
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      toast(choice?.outcome === 'accepted' ? "‚úÖ Instalaci√≥n iniciada" : "Instalaci√≥n cancelada", true);
    });

    // Service worker register (si existe sw.js)
    (async ()=>{
      if('serviceWorker' in navigator){
        try{
          await navigator.serviceWorker.register('./sw.js', { scope:'./' });
        }catch(e){}
      }
    })();

    // Bot modal
    document.getElementById('btnBot').addEventListener('click', ()=>{
      toast("ü§ñ Asistente: (Siguiente paso) chat/voz dentro de la app. Hoy dejamos la base lista.", true);
    });

    // Update button (recarga con sonido)
    document.getElementById('btnUpdate').addEventListener('click', ()=>{
      ding();
      toast("Actualizando versi√≥n‚Ä¶", true);
      setTimeout(()=>location.reload(true), 350);
    });

    // Bottom nav quick toasts
    const navBtns = ["navHome","navCaja","navInv","navProd","navVentas"].map(id=>document.getElementById(id));
    navBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        navBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        toast("M√≥dulo: " + b.textContent.replace(/\s+/g,' ').trim(), true);
      });
    });
  </script>

  <!-- Firebase (TODO dentro de ESTE m√≥dulo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, enableIndexedDbPersistence,
      doc, getDoc, setDoc, updateDoc,
      collection, addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Firebase config (tu proyecto) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCGPDlRAIKsrI6EhE3Tb2-1sYJ1VDaH2jw",
      authDomain: "rauli-e7fdb.firebaseapp.com",
      projectId: "rauli-e7fdb",
      storageBucket: "rauli-e7fdb.firebasestorage.app",
      messagingSenderId: "406292569158",
      appId: "1:406292569158:web:c26f46de60d31827317e47",
      measurementId: "G-PVC6X0TTTL"
    };

    // ===== init =====
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Offline-first Firestore (si falla, igual funciona online)
    try { await enableIndexedDbPersistence(db); } catch(e) {}

    // Helpers
    const RAULI_BIZ = "rauli";
    const subCol = (name) => collection(db, "business", RAULI_BIZ, name);
    const bizDocRef = () => doc(db, "business", RAULI_BIZ);

    const ROLES = {
      owner:   { name:"Ra√∫l (Due√±o)",        modules:["Caja","Inventario","Producci√≥n","Ventas","Contabilidad","Auditor√≠a","Configuraci√≥n"] },
      coowner: { name:"Lisi (Co-propietaria)",modules:["Caja","Inventario","Producci√≥n","Ventas","Contabilidad","Auditor√≠a"] },
      supervisor:{name:"Orlandito (Supervisor)",modules:["Calidad","Inventario","Producci√≥n","Ventas","Auditor√≠a"] },
      admin_ops:{name:"Papito (Producci√≥n)", modules:["Producci√≥n","Inventario","Ventas","Caja"] },
      accountant:{name:"Bety (Contadora)",   modules:["Caja","Gastos","Cierres","Evidencias","Auditor√≠a"] },
    };

    const $ = (id)=>document.getElementById(id);

    function nowISO(){
      const d=new Date();
      return d.toISOString().slice(0,10);
    }

    function toast(msg, ok=true){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.toggle('bad', !ok);
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2600);
    }

    // ===== PROBAR NUBE (crea documento) =====
    async function probeCloud(){
      try{
        await addDoc(collection(db, "business", RAULI_BIZ, "events"), {
          type:"test",
          desc:"Prueba Firestore OK (RAULI)",
          clientTime: Date.now(),
          createdAt: serverTimestamp()
        });
        toast("‚úÖ ¬°Listo! Firestore escribi√≥. Ve a Firebase > Datos.", true);
      }catch(e){
        toast("‚ùå Error Firestore: " + (e?.message || e), false);
      }
    }

    // ===== Inicializar base real (solo owner) =====
    async function ensureBizMeta(){
      const ref = bizDocRef();
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          name:"Panader√≠a & Dulcer√≠a RAULI",
          createdAt: serverTimestamp(),
          version:"v1",
          status:"active"
        });
      }
    }

    async function ensureConfig(){
      const ref = doc(db, "business", RAULI_BIZ, "config", "general");
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          currency:"USD",
          timezone:"America/New_York",
          lowStockThreshold: 5,
          createdAt: serverTimestamp()
        });
      }
    }

    async function seedBaseCollections(){
      const marker = { createdAt: serverTimestamp(), seed:true };

      await addDoc(subCol("inventario"), {
        ...marker, type:"insumo", sku:"HARINA-0001", name:"Harina (demo)",
        unit:"lb", qty:50, min:10, costUnit:0
      });

      await addDoc(subCol("produccion"), {
        ...marker, type:"lote", product:"Pan (demo)", qty:20, status:"en_proceso", date: nowISO()
      });

      await addDoc(subCol("ventas"), {
        ...marker, type:"venta", date: nowISO(), total:0, method:"efectivo", note:"Venta demo"
      });

      await addDoc(subCol("caja"), {
        ...marker, type:"apertura", date: nowISO(), amount:0, note:"Caja demo"
      });

      await addDoc(subCol("auditoria"), {
        ...marker, type:"seed", msg:"Base inicial creada desde RAULI", at: serverTimestamp()
      });
    }

    async function initBase(){
      try{
        await ensureBizMeta();
        await ensureConfig();
        await seedBaseCollections();
        toast("‚úÖ Base RAULI inicializada (inventario/producci√≥n/ventas/caja/auditor√≠a)", true);
      }catch(e){
        toast("‚ùå Error inicializando base: " + (e?.message || e), false);
      }
    }

    // ===== Modal por rol =====
    let currentRole = "owner";

    function openRole(roleKey){
      currentRole = roleKey;
      const r = ROLES[roleKey] || ROLES.owner;

      $("whoName").textContent = r.name;
      $("whoMeta").textContent = `Rol: ${roleKey} ¬∑ M√≥dulos: ${r.modules.length}`;

      const grid = $("moduleGrid");
      grid.innerHTML = "";
      r.modules.forEach(m=>{
        const b = document.createElement("button");
        b.className = "module";
        b.innerHTML = `<b>${m}</b><small>Abrir m√≥dulo ${m.toLowerCase()}.</small>`;
        b.onclick = async ()=>{
          try{
            await addDoc(subCol("auditoria"), {
              type:"open_module",
              module:m,
              role:roleKey,
              at: serverTimestamp()
            });
          }catch(e){}
          toast("Abriendo: " + m, true);
        };
        grid.appendChild(b);
      });

      // Solo due√±o ve Inicializar Base
      $("btnInitBase").style.display = (roleKey === "owner") ? "inline-flex" : "none";

      $("modal").classList.add("show");
    }

    function closeRole(){
      $("modal").classList.remove("show");
    }

    // ===== Acciones r√°pidas (caja/inventario) =====
    async function openCashToday(){
      try{
        await addDoc(subCol("caja"), {
          type:"apertura",
          date: nowISO(),
          amount: 0,
          byRole: currentRole,
          at: serverTimestamp(),
          note: "Apertura creada desde RAULI"
        });
        toast("‚úÖ Apertura de caja registrada", true);
      }catch(e){
        toast("‚ùå Error caja: " + (e?.message || e), false);
      }
    }

    async function quickInsumo(){
      try{
        await addDoc(subCol("inventario"), {
          type:"insumo",
          sku:"INS-" + Math.floor(Math.random()*99999),
          name:"Insumo r√°pido",
          unit:"unidad",
          qty: 1,
          min: 1,
          byRole: currentRole,
          at: serverTimestamp()
        });
        toast("‚úÖ Insumo registrado (demo)", true);
      }catch(e){
        toast("‚ùå Error inventario: " + (e?.message || e), false);
      }
    }

    // ===== Hooks UI =====
    document.getElementById("btnProbe").addEventListener("click", probeCloud);
    document.getElementById("btnInitBase").addEventListener("click", initBase);

    document.getElementById("btnClose").addEventListener("click", closeRole);
    document.getElementById("btnBack").addEventListener("click", closeRole);

    document.getElementById("btnOpenCash").addEventListener("click", openCashToday);
    document.getElementById("btnQuickInsumo").addEventListener("click", quickInsumo);

    // Cargar demo abre como due√±o
    document.getElementById("btnDemo").addEventListener("click", ()=>openRole("owner"));

    // Cards por rol
    document.querySelectorAll("#roleCards .card").forEach(card=>{
      card.addEventListener("click", ()=>{
        const role = card.getAttribute("data-role") || "owner";
        openRole(role);
      });
    });

    // Mensaje de arranque
    toast("‚úÖ RAULI listo. Usa 'Probar Nube' o entra por rol.", true);
  </script>
</body>
</html>
