<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RAULI ‚Äî Panader√≠a & Dulcer√≠a</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#123b8a">
  <link rel="icon" href="icon-512.png">

  <style>
    :root{
      --bg:#0a1222;

      /* colores marca (azul + amarillo) */
      --blue:#2f6cff;
      --blue2:#1f4fc9;
      --blueDeep:#0b2f5b;

      --yellow:#ffd24a;       /* amarillo suave legible */
      --yellowStrong:#ffc400; /* t√≠tulos */
      --yellow2:#d7a90b;

      --text: var(--yellow);  /* texto general */
      --muted:#c9d3f2;        /* ayudas */
      --muted2:#aebae0;

      --line:rgba(255,255,255,.14);
      --shadow: 0 18px 55px rgba(0,0,0,.44);
      --radius: 22px;

      /* Tipograf√≠a grande (Lisi) */
      --fs-base: 18px;
      --fs-small: 14px;
      --fs-title: 20px;
      --fs-h1: 22px;
      --fs-card-title: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: var(--fs-base);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(47,108,255,.36), transparent 55%),
        radial-gradient(1100px 700px at 95% 0%, rgba(255,196,0,.22), transparent 50%),
        radial-gradient(900px 600px at 60% 110%, rgba(47,108,255,.16), transparent 55%),
        var(--bg);
      min-height:100vh;
      overflow-x:hidden;
    }

    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}
    @keyframes pulse{0%{transform:scale(1);opacity:.85}50%{transform:scale(1.15);opacity:1}100%{transform:scale(1);opacity:.85}}
    @keyframes shimmer{0%{background-position:0% 50%}100%{background-position:100% 50%}}

    /* Top bar */
    .topbar{
      position: sticky; top:0; z-index:50;
      padding: 12px 12px 10px;
      background: linear-gradient(180deg, rgba(10,18,34,.96), rgba(10,18,34,.58));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1140px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(47,108,255,.95), rgba(255,196,0,.88));
      box-shadow: 0 12px 24px rgba(0,0,0,.30);
      animation: floaty 3.2s ease-in-out infinite;
    }
    .title{display:flex; flex-direction:column; line-height:1.12}
    .title b{letter-spacing:.4px; font-size:18px; color: var(--yellowStrong)}
    .title span{color:var(--muted); font-size:var(--fs-small)}
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      display:inline-flex; gap:8px; align-items:center;
      padding:9px 11px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.07);
      color: var(--yellow);
      font-size: var(--fs-small);
      font-weight: 950;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.online{background:#2ecc71}
    .dot.offline{background:#e74c3c}
    .pulse{
      width:10px;height:10px;border-radius:50%;
      background:#2ecc71;
      animation: pulse 1.4s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(46,204,113,.55);
    }

    /* Botones */
    .btn{
      border:0; cursor:pointer;
      font-weight: 950;
      letter-spacing:.2px;
      padding:12px 14px;
      border-radius:16px;
      color:#0b1220; /* amarillo con texto oscuro -> legible */
      background: linear-gradient(135deg, var(--yellow), var(--yellow2));
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      display:inline-flex; gap:8px; align-items:center;
      font-size: var(--fs-small);
    }
    .btn.blue{
      color:#ffe08a; /* texto amarillo sobre azul */
      background: linear-gradient(135deg, var(--blue), var(--blue2));
    }
    .btn.ghost{
      color: var(--yellow);
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.danger{
      color:#fff;
      background: linear-gradient(135deg, #e74c3c, #b3392f);
    }

    /* Main */
    .wrap{max-width:1140px;margin:0 auto;padding:16px 12px 132px}
    .hero{
      display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap;
      padding:16px 16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(90deg, rgba(47,108,255,.24), rgba(255,196,0,.18), rgba(47,108,255,.24));
      background-size: 200% 200%;
      animation: shimmer 7s ease-in-out infinite;
      opacity:.55;
      pointer-events:none;
      mask: linear-gradient(#000, transparent 70%);
    }
    .hero h1{margin:0;font-size:var(--fs-h1); color: var(--yellowStrong); position:relative}
    .hero p{margin:8px 0 0;color:var(--muted);font-size:var(--fs-base);max-width:820px; position:relative}
    .hero-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap; position:relative}

    /* Login card */
    .login-wrap{
      max-width: 760px;
      margin: 14px auto 0;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,28,51,.88), rgba(13,23,48,.78));
      box-shadow: var(--shadow);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .field{
      display:flex; flex-direction:column; gap:8px;
      flex: 1 1 260px;
    }
    label{color:var(--muted); font-weight:950; font-size: var(--fs-small)}
    input, textarea{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--yellow);
      outline:none;
      font-size: var(--fs-base);
    }
    input:focus, textarea:focus{border-color: rgba(255,196,0,.48)}
    .hint{color:var(--muted); font-size: var(--fs-small); margin-top:10px; line-height:1.45}

    /* Dashboard cards */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      padding:16px 16px 14px;
      border-radius: 20px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,28,51,.92), rgba(13,23,48,.88));
      box-shadow: 0 14px 40px rgba(0,0,0,.28);
      min-height: 140px;
      display:flex; flex-direction:column; gap:10px;
      transform: translateY(0);
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
      cursor:pointer;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow: 0 18px 54px rgba(0,0,0,.36);
      border-color: rgba(255,196,0,.36);
    }
    .card b{font-size:var(--fs-card-title); color: var(--yellowStrong)}
    .card small{color:var(--muted);line-height:1.45; font-size: var(--fs-base)}
    .card .tag{
      margin-top:auto;
      display:inline-flex; align-self:flex-start;
      padding:8px 11px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--line);
      font-weight: 950;
      font-size: var(--fs-small);
      color: var(--yellow);
    }

    /* Assistant */
    .assistant{
      margin-top: 14px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .assistant h2{margin:0; font-size: var(--fs-title); color: var(--yellowStrong)}
    .assistant p{margin:8px 0 0; color:var(--muted)}
    .assistant .box{
      margin-top:10px;
      padding: 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
    }
    .chat{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 260px;
      overflow:auto;
      padding-right:6px;
    }
    .bubble{
      max-width: 92%;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--yellow);
      font-size: var(--fs-base);
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.user{
      align-self:flex-end;
      background: rgba(47,108,255,.16);
      border-color: rgba(47,108,255,.30);
    }
    .bubble.ai{
      align-self:flex-start;
      background: rgba(255,196,0,.10);
      border-color: rgba(255,196,0,.26);
    }

    /* Bottom nav */
    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      z-index:60;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(10,18,34,.00), rgba(10,18,34,.95));
      backdrop-filter: blur(10px);
    }
    .bottom-inner{
      max-width:1140px;margin:0 auto;
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(8,12,20,.68);
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      box-shadow: var(--shadow);
      flex-wrap:wrap;
    }
    .nav{display:flex; gap:8px; flex-wrap:wrap}
    .nav button{
      padding:11px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--yellow);
      font-weight: 950;
      cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
      font-size: var(--fs-small);
    }
    .nav button.active{
      color:#ffe08a;
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      border:0;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:9999;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
    }
    .modal.show{display:flex}
    .sheet{
      width:min(960px,100%);
      border-radius: 24px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,35,85,.96), rgba(10,14,22,.96));
      box-shadow: 0 22px 80px rgba(0,0,0,.50);
      overflow:hidden;
    }
    .sheet-top{
      padding:14px 16px;
      display:flex; gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }
    .sheet-top .who{display:flex; flex-direction:column; gap:3px}
    .sheet-top .who b{letter-spacing:.2px; font-size: 17px; color: var(--yellowStrong)}
    .sheet-top .who span{color:var(--muted);font-size:var(--fs-small)}
    .sheet-body{padding:14px 16px}
    .module-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .module-grid{grid-template-columns:1fr;} }
    .module{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      cursor:pointer;
      text-align:left;
      transition: transform .14s ease, border-color .14s ease;
      color: var(--yellow);
    }
    .module:hover{
      transform: translateY(-2px);
      border-color: rgba(255,196,0,.42);
    }
    .module b{display:block; font-size: 16px; color: var(--yellowStrong)}
    .module small{display:block;color:var(--muted);margin-top:6px;line-height:1.45; font-size: var(--fs-base)}
    .quick{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 98px;
      z-index:99999;
      padding:12px 14px;
      border-radius: 14px;
      color:#ffe08a;
      font: 14px system-ui;
      box-shadow: 0 12px 34px rgba(0,0,0,.28);
      background: rgba(11,47,91,.92);
      display:none;
      max-width: min(640px, 92vw);
      border: 1px solid rgba(255,196,0,.22);
    }
    .toast.show{display:block}
    .toast.bad{
      background: rgba(139,0,0,.92);
      border-color: rgba(255,255,255,.12);
      color: #fff;
    }

    .footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: var(--fs-small);
      text-align:center;
      opacity:.92;
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>RAULI</b>
          <span id="subTitle">Panader√≠a & Dulcer√≠a ¬∑ Offline-first + IA</span>
        </div>
      </div>

      <div class="chips">
        <button class="btn" id="btnUpdate">üîî Actualizar</button>

        <span class="chip" id="chipConn"><span class="dot offline"></span> Offline</span>
        <span class="chip" id="chipSync">üü• Sin se√±al (guardando local)</span>

        <span class="chip" id="chipQueue" style="display:none">ü§ñ IA pendiente: 0</span>
        <span class="chip" id="chipUser" style="display:none">üë§ ‚Äî</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <div>
        <h1>RAULI Operativo (IA + Offline)</h1>
        <p>
          La app guarda todo sin se√±al (offline-first). El asistente guarda mensajes en cola y cuando vuelve la se√±al, los env√≠a
          y solicita respuesta a la IA (Cloud Function <b>rauliAssistant</b>).
        </p>
      </div>
      <div class="hero-actions">
        <button class="btn blue" id="btnProbe">üöÄ Probar Nube</button>
        <button class="btn ghost" id="btnInstall">üì≤ Instalar App</button>
        <button class="btn ghost" id="btnAbout">‚ÑπÔ∏è Acerca de</button>
        <button class="btn danger" id="btnLogout" style="display:none">Salir</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="login-wrap" id="loginBox">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
        <div>
          <b style="font-size:18px;color:var(--yellowStrong)">üîê Iniciar sesi√≥n</b>
          <div class="hint">Usa el correo/clave creado en Firebase Authentication.</div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="field">
          <label>Correo</label>
          <input id="email" type="email" placeholder="ej: bety@rauli.com" autocomplete="username">
        </div>
        <div class="field">
          <label>Clave</label>
          <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn blue" id="btnLogin">Entrar</button>
        <button class="btn ghost" id="btnDemo">Entrar demo (sin login)</button>
      </div>

      <div class="hint">
        <b>Nota:</b> Demo es para ver pantallas. Para IA real y seguridad, usa login.
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashBox" style="display:none">
      <div class="grid" id="roleCards"></div>

      <!-- Asistente -->
      <div class="assistant" id="assistantSection">
        <h2>ü§ñ Asistente RAULI (Offline ‚Üí Online IA)</h2>
        <p>
          Escribe o dicta. Si no hay se√±al, se guarda. Cuando vuelve internet, se env√≠a y se consulta la IA.
        </p>

        <div class="box">
          <textarea id="assistantInput" placeholder="Ej: 'Bety: cierre de caja, faltan $10, revisar evidencias'"></textarea>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn blue" id="btnSendIA">Enviar / Guardar</button>
            <button class="btn ghost" id="btnVoice">üéôÔ∏è Dictar</button>
            <button class="btn ghost" id="btnFlushIA">üì° Enviar cola</button>
          </div>

          <div class="hint" id="queueHint">ü§ñ IA pendiente: 0</div>

          <div class="chat" id="chat"></div>
        </div>
      </div>

      <div class="footer">
        Sistema RAULI ¬© 2026 ¬∑ Prototipo asistido por <b>ChatGPT (GPT-5.2 Thinking)</b> ¬∑ Autor del prototipo RAULI
      </div>
    </div>
  </div>

  <!-- Bottom -->
  <div class="bottom">
    <div class="bottom-inner">
      <div class="nav">
        <button class="active" id="navHome">üè† Inicio</button>
        <button id="navCaja">üí∞ Caja</button>
        <button id="navInv">üì¶ Inventario</button>
        <button id="navProd">ü•ñ Producci√≥n</button>
        <button id="navVentas">üßæ Ventas</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn ghost" id="btnOpenPanel">üß≠ Panel</button>
      </div>
    </div>
  </div>

  <!-- Modal Panel por Rol -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheet-top">
        <div class="who">
          <b id="whoName">Usuario</b>
          <span id="whoMeta">Rol ¬∑ M√≥dulos disponibles</span>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="btnInitBase" style="display:none">üì¶ Inicializar base</button>
          <button class="btn ghost" id="btnClose">Cerrar</button>
        </div>
      </div>
      <div class="sheet-body">
        <div class="module-grid" id="moduleGrid"></div>

        <div class="quick">
          <button class="btn blue" id="btnOpenCash">üí∞ Apertura de caja (hoy)</button>
          <button class="btn ghost" id="btnQuickInsumo">üì¶ Registrar insumo (r√°pido)</button>
          <button class="btn ghost" id="btnBack">‚Ü©Ô∏è Volver</button>
        </div>
      </div>
    </div>
  </div>

  <!-- About modal -->
  <div class="modal" id="aboutModal">
    <div class="sheet">
      <div class="sheet-top">
        <div class="who">
          <b>‚ÑπÔ∏è Acerca de RAULI</b>
          <span>Offline-first + Firestore + IA por Cloud Functions</span>
        </div>
        <button class="btn ghost" id="btnAboutClose">Cerrar</button>
      </div>
      <div class="sheet-body">
        <div class="module" style="cursor:default">
          <b>Autor</b>
          <small>ChatGPT (GPT-5.2 Thinking) ‚Äî Autor del prototipo RAULI.</small>
        </div>
        <div class="module" style="cursor:default;margin-top:10px">
          <b>IA (modo profesional)</b>
          <small>
            La app llama a la Cloud Function <b>rauliAssistant</b>. Offline: se guarda en cola local y se env√≠a al recuperar se√±al.
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- UI Script (NO module) -->
  <script>
    // Toast
    const toastEl = document.getElementById('toast');
    function toast(msg, ok=true){
      toastEl.textContent = msg;
      toastEl.classList.toggle('bad', !ok);
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2800);
    }

    // Campanita (WebAudio)
    function ding(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
        o.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.08);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
        setTimeout(()=>{ o.stop(); ctx.close(); }, 320);
      }catch(e){}
    }

    // Online/Offline Chips
    const chipConn = document.getElementById('chipConn');
    const chipSync = document.getElementById('chipSync');
    function paintConn(){
      const online = navigator.onLine;
      chipConn.innerHTML = online
        ? `<span class="dot online"></span> Online`
        : `<span class="dot offline"></span> Offline`;
      chipSync.textContent = online ? "‚úÖ En l√≠nea (guardando local tambi√©n)" : "üü• Sin se√±al (guardando local)";
    }
    window.addEventListener('online', ()=>{ paintConn(); toast("üü¢ Conexi√≥n restablecida. Sincronizando‚Ä¶", true); });
    window.addEventListener('offline', ()=>{ paintConn(); toast("üü° Sin conexi√≥n. Guardando local.", true); });
    paintConn();

    // PWA install
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
    });

    document.getElementById('btnInstall').addEventListener('click', async ()=>{
      if(!deferredPrompt){
        toast("iPhone: Safari ‚Üí Compartir ‚Üí 'Agregar a inicio'. Android/PC: Chrome mostrar√° instalar si PWA est√° OK.", true);
        return;
      }
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      toast(choice?.outcome === 'accepted' ? "‚úÖ Instalaci√≥n iniciada" : "Instalaci√≥n cancelada", true);
    });

    // SW register (si existe sw.js)
    (async ()=>{
      if('serviceWorker' in navigator){
        try{ await navigator.serviceWorker.register('./sw.js', { scope:'./' }); }
        catch(e){}
      }
    })();

    // Update
    document.getElementById('btnUpdate').addEventListener('click', async ()=>{
      ding();
      toast("Actualizando versi√≥n‚Ä¶", true);
      try{
        // intenta pedir update a SW si existe
        const reg = await navigator.serviceWorker?.getRegistration();
        if(reg) await reg.update();
      }catch(e){}
      setTimeout(()=>location.reload(true), 350);
    });

    // About
    const aboutModal = document.getElementById('aboutModal');
    document.getElementById('btnAbout').addEventListener('click', ()=>aboutModal.classList.add('show'));
    document.getElementById('btnAboutClose').addEventListener('click', ()=>aboutModal.classList.remove('show'));

    // Bottom nav feedback
    const navBtns = ["navHome","navCaja","navInv","navProd","navVentas"].map(id=>document.getElementById(id));
    navBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        navBtns.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        toast("M√≥dulo: " + b.textContent.replace(/\s+/g,' ').trim(), true);
      });
    });

    // helpers chat UI
    function chatAdd(text, who="user"){
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "bubble " + (who === "ai" ? "ai" : "user");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>

  <!-- Firebase + App Logic (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, enableIndexedDbPersistence,
      doc, getDoc, setDoc,
      collection, addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFunctions, httpsCallable
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-functions.js";

    // ===== Firebase config (tu proyecto) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCGPDlRAIKsrI6EhE3Tb2-1sYJ1VDaH2jw",
      authDomain: "rauli-e7fdb.firebaseapp.com",
      projectId: "rauli-e7fdb",
      storageBucket: "rauli-e7fdb.firebasestorage.app",
      messagingSenderId: "406292569158",
      appId: "1:406292569158:web:c26f46de60d31827317e47",
      measurementId: "G-PVC6X0TTTL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const functions = getFunctions(app);

    // Offline-first Firestore
    try { await enableIndexedDbPersistence(db); } catch(e) {}

    const $ = (id)=>document.getElementById(id);
    const RAULI_BIZ = "rauli";
    const bizDocRef = () => doc(db, "business", RAULI_BIZ);
    const subCol = (name) => collection(db, "business", RAULI_BIZ, name);
    const userProfileRef = (uid)=>doc(db, "business", RAULI_BIZ, "users", uid);

    // Roles (como acordamos)
    const ROLES = {
      owner: { name:"Ra√∫l (Due√±o)", modules:["Caja","Inventario","Producci√≥n","Ventas","Contabilidad","Auditor√≠a","Configuraci√≥n"] },
      co_owner: { name:"Lisi (Co-propietaria)", modules:["Caja","Inventario","Producci√≥n","Ventas","Contabilidad","Auditor√≠a"] },
      supervisor: { name:"Orlandito (Supervisor)", modules:["Calidad","Inventario","Producci√≥n","Ventas","Auditor√≠a"] },
      admin_produccion: { name:"Papito (Producci√≥n)", modules:["Producci√≥n","Inventario","Ventas","Caja"] },
      contadora: { name:"Bety (Contadora)", modules:["Caja","Finanzas","Cierres","Evidencias","Auditor√≠a"] }
    };

    // UI helpers from non-module script
    const toast = window.toast;
    const ding = window.ding;
    const chatAdd = window.chatAdd;

    // Session
    let current = { uid:null, email:null, role:null, displayName:null };

    function showLogin(){
      $("loginBox").style.display = "block";
      $("dashBox").style.display = "none";
      $("btnLogout").style.display = "none";
      $("chipUser").style.display = "none";
      $("chipQueue").style.display = "none";
    }
    function showDash(){
      $("loginBox").style.display = "none";
      $("dashBox").style.display = "block";
      $("btnLogout").style.display = "inline-flex";
      $("chipUser").style.display = "inline-flex";
      $("chipUser").textContent = `üë§ ${current.displayName || current.email || 'Usuario'} ¬∑ ${current.role || 'rol'}`;
      $("chipQueue").style.display = "inline-flex";
      updateQueueUI();
    }

    // ---- Base init (solo due√±o) ----
    function nowISO(){ return new Date().toISOString().slice(0,10); }

    async function ensureBizMeta(){
      const ref = bizDocRef();
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          name:"Panader√≠a & Dulcer√≠a RAULI",
          createdAt: serverTimestamp(),
          version:"v3-ia",
          status:"active"
        });
      }
    }
    async function ensureConfig(){
      const ref = doc(db, "business", RAULI_BIZ, "config", "general");
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          currency:"USD",
          timezone:"America/New_York",
          lowStockThreshold: 5,
          createdAt: serverTimestamp()
        });
      }
    }
    async function seedBase(){
      const marker = { createdAt: serverTimestamp(), seed:true };
      await addDoc(subCol("inventario"), { ...marker, type:"insumo", sku:"HARINA-0001", name:"Harina (demo)", unit:"lb", qty:50, min:10 });
      await addDoc(subCol("produccion"), { ...marker, type:"lote", product:"Pan (demo)", qty:20, status:"en_proceso", date: nowISO() });
      await addDoc(subCol("ventas"), { ...marker, type:"venta", date: nowISO(), total:0, method:"efectivo", note:"Venta demo" });
      await addDoc(subCol("caja"), { ...marker, type:"apertura", date: nowISO(), amount:0, note:"Caja demo" });
      await addDoc(subCol("auditoria"), { ...marker, type:"seed", msg:"Base inicial creada desde RAULI", at: serverTimestamp() });
    }
    async function initBase(){
      try{
        await ensureBizMeta();
        await ensureConfig();
        await seedBase();
        toast("‚úÖ Base RAULI inicializada", true);
      }catch(e){
        toast("‚ùå Error inicializando base: " + (e?.message || e), false);
      }
    }

    // ---- Panel por rol (modal) ----
    function openPanel(){
      const modal = $("modal");
      const r = ROLES[current.role] || ROLES.owner;
      $("whoName").textContent = current.displayName || r.name;
      $("whoMeta").textContent = `Rol: ${current.role} ¬∑ M√≥dulos: ${r.modules.length}`;
      $("btnInitBase").style.display = (current.role === "owner") ? "inline-flex" : "none";

      const grid = $("moduleGrid");
      grid.innerHTML = "";
      r.modules.forEach(m=>{
        const b = document.createElement("button");
        b.className = "module";
        b.innerHTML = `<b>${m}</b><small>Entrar a ${m.toLowerCase()} y registrar evidencias.</small>`;
        b.onclick = async ()=>{
          try{
            await addDoc(subCol("auditoria"), {
              type:"open_module",
              module:m,
              role: current.role,
              uid: current.uid || null,
              at: serverTimestamp()
            });
          }catch(e){}
          toast("Abriendo: " + m, true);
        };
        grid.appendChild(b);
      });

      modal.classList.add("show");
    }
    function closePanel(){ $("modal").classList.remove("show"); }

    $("btnClose").addEventListener("click", closePanel);
    $("btnBack").addEventListener("click", closePanel);
    $("btnOpenPanel").addEventListener("click", openPanel);
    $("btnInitBase").addEventListener("click", initBase);

    // Quick actions
    $("btnOpenCash").addEventListener("click", async ()=>{
      try{
        await addDoc(subCol("caja"), {
          type:"apertura",
          date: nowISO(),
          amount: 0,
          byRole: current.role,
          uid: current.uid,
          at: serverTimestamp(),
          note: "Apertura creada desde RAULI"
        });
        toast("‚úÖ Apertura de caja registrada", true);
      }catch(e){
        toast("‚ùå Error caja: " + (e?.message || e), false);
      }
    });

    $("btnQuickInsumo").addEventListener("click", async ()=>{
      try{
        await addDoc(subCol("inventario"), {
          type:"insumo",
          sku:"INS-" + Math.floor(Math.random()*99999),
          name:"Insumo r√°pido",
          unit:"unidad",
          qty: 1,
          min: 1,
          byRole: current.role,
          uid: current.uid,
          at: serverTimestamp()
        });
        toast("‚úÖ Insumo registrado (demo)", true);
      }catch(e){
        toast("‚ùå Error inventario: " + (e?.message || e), false);
      }
    });

    // ---- Probar nube ----
    $("btnProbe").addEventListener("click", async ()=>{
      try{
        await addDoc(collection(db, "business", RAULI_BIZ, "events"), {
          type:"test",
          desc:"Prueba Firestore OK (RAULI v3 IA)",
          uid: current.uid || null,
          role: current.role || null,
          clientTime: Date.now(),
          createdAt: serverTimestamp()
        });
        toast("‚úÖ ¬°Listo! Firestore escribi√≥. Ve a Firebase > Datos.", true);
      }catch(e){
        toast("‚ùå Error Firestore: " + (e?.message || e), false);
      }
    });

    // ---- Render dashboard (una tarjeta por tu rol) ----
    function renderDashboard(){
      const holder = $("roleCards");
      holder.innerHTML = "";
      const r = ROLES[current.role] || ROLES.owner;

      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `
        <b>${r.name}</b>
        <small>Tu panel est√° listo. Entra a tus m√≥dulos y registra evidencias. La IA te ayuda y guarda offline.</small>
        <span class="tag">Abrir panel</span>
      `;
      c.addEventListener("click", openPanel);
      holder.appendChild(c);
    }

    // ---- IA OFFLINE-FIRST + ONLINE Function ----
    const IA_QUEUE_KEY = "rauli_ia_queue_v2";
    function getQueue(){
      try{ return JSON.parse(localStorage.getItem(IA_QUEUE_KEY) || "[]"); }catch(e){ return []; }
    }
    function setQueue(q){
      localStorage.setItem(IA_QUEUE_KEY, JSON.stringify(q));
      updateQueueUI();
    }
    function updateQueueUI(){
      const q = getQueue();
      $("queueHint").textContent = `ü§ñ IA pendiente: ${q.length}`;
      $("chipQueue").textContent = `ü§ñ IA pendiente: ${q.length}`;
    }
    updateQueueUI();

    async function saveAssistantMessage(type, text, extra={}){
      // Guardamos en Firestore (offline persistence se encarga si no hay internet)
      try{
        await addDoc(subCol("assistantMessages"), {
          type, text,
          uid: current.uid || null,
          role: current.role || null,
          email: current.email || null,
          clientTime: Date.now(),
          createdAt: serverTimestamp(),
          ...extra
        });
      }catch(e){
        // si falla por reglas o algo, no bloqueamos el flujo
      }
    }

    async function callFunctionAI(text){
      // Llama Cloud Function: rauliAssistant
      // Si no est√° desplegada a√∫n, fallar√° y caemos a respuesta local.
      const fn = httpsCallable(functions, "rauliAssistant");
      const res = await fn({ text, role: current.role || "operacion" });
      return res?.data?.answer || "No hubo respuesta de IA.";
    }

    function localFallbackAI(text){
      // Respuesta local √∫til cuando no hay function
      const t = text.toLowerCase();
      if(t.includes("caja") || t.includes("falt") || t.includes("efectivo")){
        return "üîé Revisi√≥n r√°pida: registra evidencia, verifica movimientos de caja y confirma cierre. Si falta efectivo, deja nota + responsable + foto.";
      }
      if(t.includes("inventario") || t.includes("insumo") || t.includes("harina")){
        return "üì¶ Inventario: registra entrada/salida del insumo, valida m√≠nimo, y crea alerta si baja de umbral. Adjunta evidencia (factura/foto).";
      }
      if(t.includes("venta") || t.includes("ventas")){
        return "üßæ Ventas: registra el total, m√©todo de pago y evidencia. Si es reembolso, anota motivo y firma/responsable.";
      }
      return "‚úÖ Recibido. Qued√≥ registrado. (IA completa se activar√° al conectar la Cloud Function).";
    }

    async function askIA(text, source="texto"){
      if(!text || !text.trim()){
        toast("Escribe un mensaje para el asistente", false);
        return;
      }

      // Mostrar burbuja del usuario
      chatAdd(text, "user");
      await saveAssistantMessage("user", text, { source });

      // OFFLINE -> cola
      if(!navigator.onLine){
        const q = getQueue();
        q.push({ id: crypto.randomUUID(), text, source, ts: Date.now(), role: current.role || "operacion" });
        setQueue(q);
        toast("üü• Sin conexi√≥n: guardado en cola IA", true);
        chatAdd("üü• Sin conexi√≥n: guard√© tu mensaje. Se enviar√° cuando vuelva la se√±al.", "ai");
        return;
      }

      // ONLINE -> intenta function, si falla usa fallback
      toast("ü§ñ Consultando IA‚Ä¶", true);
      let answer = "";
      try{
        answer = await callFunctionAI(text);
        ding();
      }catch(e){
        answer = localFallbackAI(text);
      }
      chatAdd(answer, "ai");
      await saveAssistantMessage("ai", answer, { inResponseTo: text, source:"ai" });
    }

    async function flushQueue(){
      const q = getQueue();
      if(!q.length){
        toast("Cola IA vac√≠a ‚úÖ", true);
        return;
      }
      if(!navigator.onLine){
        toast("Sin se√±al: no puedo enviar la cola", false);
        return;
      }

      toast(`üì° Enviando cola IA (${q.length})‚Ä¶`, true);

      const remaining = [];
      for(const item of q){
        try{
          // re-procesar con IA
          let answer = "";
          try{
            answer = await callFunctionAI(item.text);
            ding();
          }catch(e){
            answer = localFallbackAI(item.text);
          }
          // registrar
          await saveAssistantMessage("user", item.text, { fromQueue:true, source:item.source, ts:item.ts });
          await saveAssistantMessage("ai", answer, { fromQueue:true, source:"ai", inResponseTo:item.id });

          chatAdd(`(Desde cola) ${item.text}`, "user");
          chatAdd(answer, "ai");
        }catch(e){
          remaining.push(item);
        }
      }
      setQueue(remaining);
      toast(remaining.length ? `‚ö†Ô∏è Quedaron ${remaining.length} en cola` : "‚úÖ Cola IA enviada completa", !remaining.length);
    }

    $("btnSendIA").addEventListener("click", async ()=>{
      const text = $("assistantInput").value.trim();
      if(!text) return toast("Escribe un mensaje", false);
      $("assistantInput").value = "";
      await askIA(text, "texto");
      updateQueueUI();
    });

    $("btnFlushIA").addEventListener("click", async ()=>{
      await flushQueue();
      updateQueueUI();
    });

    // Auto-flush cuando vuelva se√±al
    window.addEventListener("online", async ()=>{
      await flushQueue().catch(()=>{});
      updateQueueUI();
    });

    // Voz (dictado)
    let recognizing = false;
    let recog = null;
    function setupVoice(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;
      const r = new SR();
      r.lang = "es-ES";
      r.interimResults = true;
      r.continuous = false;
      return r;
    }
    recog = setupVoice();

    $("btnVoice").addEventListener("click", ()=>{
      if(!recog){
        toast("Dictado no disponible en este navegador.", false);
        return;
      }
      if(recognizing){ recog.stop(); return; }
      recognizing = true;
      toast("üéôÔ∏è Dictando‚Ä¶", true);

      let finalText = "";
      recog.onresult = (ev)=>{
        let interim = "";
        for (let i = ev.resultIndex; i < ev.results.length; i++){
          const tr = ev.results[i][0].transcript;
          if(ev.results[i].isFinal) finalText += tr + " ";
          else interim += tr;
        }
        $("assistantInput").value = (finalText + interim).trim();
      };
      recog.onerror = ()=>{ recognizing=false; toast("Error de voz. Intenta otra vez.", false); };
      recog.onend = ()=>{ recognizing=false; toast("‚úÖ Dictado listo. Puedes enviar.", true); };
      recog.start();
    });

    // ---- Login ----
    $("btnLogin").addEventListener("click", async ()=>{
      const email = $("email").value.trim();
      const pass = $("pass").value;
      if(!email || !pass) return toast("Completa correo y clave", false);
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        toast("‚úÖ Sesi√≥n iniciada", true);
      }catch(e){
        toast("‚ùå Login error: " + (e?.message || e), false);
      }
    });

    $("btnLogout").addEventListener("click", async ()=>{
      try{
        await signOut(auth);
        toast("Sesi√≥n cerrada", true);
      }catch(e){
        toast("Error al salir", false);
      }
    });

    // Demo
    $("btnDemo").addEventListener("click", ()=>{
      current = { uid:null, email:"demo@rauli", role:"owner", displayName:"Demo (Due√±o)" };
      showDash();
      renderDashboard();
      toast("Modo demo activado", true);
    });

    // Auth state
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        current = { uid:null, email:null, role:null, displayName:null };
        showLogin();
        return;
      }

      current.uid = user.uid;
      current.email = user.email || null;

      // Cargar perfil (role/name) desde Firestore: business/rauli/users/{uid}
      try{
        const snap = await getDoc(userProfileRef(user.uid));
        if(snap.exists()){
          const data = snap.data();
          current.role = data.role || "owner";
          current.displayName = data.name || user.email || "Usuario";
        }else{
          // fallback (no bloquea)
          current.role = "owner";
          current.displayName = user.email || "Usuario";
        }
      }catch(e){
        current.role = "owner";
        current.displayName = user.email || "Usuario";
      }

      showDash();
      renderDashboard();

      // Auditor√≠a login
      try{
        await addDoc(subCol("auditoria"), {
          type:"login",
          uid: current.uid,
          email: current.email,
          role: current.role,
          at: serverTimestamp()
        });
      }catch(e){}

      toast(`‚úÖ Bienvenido: ${current.displayName}`, true);

      // si hay se√±al, intenta enviar cola IA
      if(navigator.onLine) flushQueue().catch(()=>{});
      updateQueueUI();
    });

  </script>
</body>
</html>
